<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ™®å¹³_ç¾©å·¥QRCodeåˆ·å¡</title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #f9f9f9;
      text-align: center;
      padding: 60px 20px;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      margin: auto;
      box-sizing: border-box;
    }

    input, select, button {
      font-size: 1.2em;
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    #submitBtn {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    #submitBtn:hover {
      background-color: #45a049;
    }

    #result {
      margin-top: 20px;
      font-size: 1.4em;
      font-weight: bold;
      padding: 12px;
      border-radius: 8px;
      display: inline-block;
      transition: all 0.3s ease;
    }

    .hidden {
      display: none;
    }

    #clock {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 1.1em;
      color: #555;
    }
  </style>
</head>
<body onload="initClock(); document.getElementById('codeInput').focus();">
  <div id="clock"></div>
  <div class="container">
    <h1>æ™®å¹³_ç¾©å·¥QRCodeåˆ·å¡</h1>
    <div id="loading" class="hidden" style="color:#555; margin-top:10px;">
    ğŸ”„ è™•ç†ä¸­ï¼Œè«‹ç¨å€™...
  </div>
    <input type="text" id="codeInput" placeholder="è«‹æƒæå¡è™Ÿ" onkeydown="checkEnter(event)" />
    <div>
      <select id="groupSelect" onchange="handleGroupChange()">
        <option value="">è«‹é¸æ“‡çµ„åˆ¥</option>
        <option value="å¤§å¯®">å¤§å¯®</option>
        <option value="æ‰“ä¾¿ç•¶">æ‰“ä¾¿ç•¶</option>
        <option value="ç…§å®¢">ç…§å®¢</option>
        <option value="è­·ç­">è­·ç­</option>
        <option value="æ›¸è¨˜">æ›¸è¨˜</option>
        <option value="äº¤é€š">äº¤é€š</option>
        <option value="å®‰å…¨">å®‰å…¨</option>
        <option value="å¿ƒç‡ˆ-æ”¶ä¾›æ°´">å¿ƒç‡ˆ-æ”¶ä¾›æ°´</option>
        <option value="å¤§å¯®å–„å¾Œ">å¤§å¯®å–„å¾Œ</option>
        <option value="æ®¿å ‚æ¸…æ·¨æ…§">æ®¿å ‚æ¸…æ·¨æ…§</option>
        <option value="ç’°ä¿">ç’°ä¿</option>
        <option value="ç¾å·¥">ç¾å·¥</option>
        <option value="è³‡æ–™">è³‡æ–™</option>
        <option value="è³‡è¨Š">è³‡è¨Š</option>
        <option value="åº¶å‹™">åº¶å‹™</option>
        <option value="æ´»å‹•">æ´»å‹•</option>
        <option value="æ¢µå”„">æ¢µå”„</option>
        <option value="éŸ³éŸ¿">éŸ³éŸ¿</option>
        <option value="è¦–è¨Š">è¦–è¨Š</option>
        <option value="æ”å½±">æ”å½±</option>
        <option value="å¸å„€">å¸å„€</option>
        <option value="èŠ±è—">èŠ±è—</option>
        <option value="æ©Ÿå‹•ä½ˆå ´">æ©Ÿå‹•ä½ˆå ´</option>
        <option value="å°è€å¸«">å°è€å¸«</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
    </div>
    <div id="classDiv" class="hidden">
      <select id="classSelect">
        <option value="">è«‹é¸æ“‡ç­ç´š</option>
        <option value="æ—¥åˆç­">æ—¥åˆç­</option>
        <option value="æ—¥ä¸­ç­">æ—¥ä¸­ç­</option>
        <option value="æ—¥é«˜ç­">æ—¥é«˜ç­</option>
        <option value="æ—¥ç ”ç­">æ—¥ç ”ç­</option>
        <option value="å¤œåˆç­">å¤œåˆç­</option>
        <option value="å¤œä¸­ç­">å¤œä¸­ç­</option>
        <option value="å¤œé«˜ç­">å¤œé«˜ç­</option>
        <option value="å¤œç ”ä¸€">å¤œç ”ä¸€</option>
        <option value="å¤œç ”å››">å¤œç ”å››</option>
      </select>
    </div>
    <div id="otherGroupDiv" class="hidden">
      <input type="text" id="otherGroupInput" placeholder="è«‹è¼¸å…¥çµ„åˆ¥åç¨±" />
    </div>
    <div>
      <select id="actionSelect">
        <option value="ç°½åˆ°">ç°½åˆ°</option>
        <option value="ç°½é€€">ç°½é€€</option>
      </select>
    </div>
    <button id="submitBtn" onclick="submitCheckIn()">é€å‡º</button>
    <div id="result"></div>
  </div>
  <script>
    function checkEnter(e) {
      if (e.key === "Enter") submitCheckIn();
    }

    function handleGroupChange() {
      const group = document.getElementById("groupSelect").value;
      document.getElementById("classDiv").classList.toggle("hidden", group !== "è­·ç­");
      document.getElementById("otherGroupDiv").classList.toggle("hidden", group !== "å…¶ä»–");
    }

  function submitCheckIn() {
  const code = document.getElementById("codeInput").value.trim();
  const group = document.getElementById("groupSelect").value;
  const action = document.getElementById("actionSelect").value;
  const className = document.getElementById("classSelect").value;
  const otherGroup = document.getElementById("otherGroupInput").value.trim();

  if (!code) return showResult("âš ï¸ è«‹æƒæå¡è™Ÿ", "orange");
  if (!group) return showResult("âš ï¸ è«‹é¸æ“‡çµ„åˆ¥", "orange");
  if (group === "è­·ç­" && !className) return showResult("âš ï¸ è«‹é¸æ“‡ç­ç´š", "orange");
  if (group === "å…¶ä»–" && !otherGroup) return showResult("âš ï¸ è«‹è¼¸å…¥çµ„åˆ¥åç¨±", "orange");

  const finalGroup = group === "å…¶ä»–" ? otherGroup : group;

  // âœ… é¡¯ç¤ºè™•ç†ä¸­
  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("result").innerHTML = "";

  // âœ… å„²å­˜ group çµ¦é¡¯ç¤ºç”¨ï¼ˆé¿å…å¾Œé¢æ¸…æ‰ç•«é¢çœ‹ä¸åˆ°ï¼‰
  const displayGroup = finalGroup;

 fetch('https://script.google.com/macros/s/AKfycbwIDIHkoNQ5tku9btC6UxG8rpuLfalLytpKqw8hJ9dtpLOsCZ0ZciFc7OIsMAujt8aT7Q/exec', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    cardNumber: code,
    group: finalGroup,
    action,
    className: group === "è­·ç­" ? className : ""
  })
})
.then(res => res.json())
.then(response => displayResult({ ...response, displayGroup: finalGroup }))
.catch(err => {
  document.getElementById("loading").classList.add("hidden");
  showResult("âŒ å‚³é€å¤±æ•—ï¼š" + err, "red");
});
    
  // âœ… æ¸…ç©ºè¡¨å–®æ¬„ä½ï¼ˆä¹‹å¾ŒåŸ·è¡Œï¼‰
  document.getElementById("codeInput").value = "";
  document.getElementById("codeInput").focus();
  document.getElementById("groupSelect").value = "";
  document.getElementById("classSelect").value = "";
  document.getElementById("otherGroupInput").value = "";
  handleGroupChange(); // ç¢ºä¿éš±è—ç­ç´š/å…¶ä»–æ¬„ä½
}

function displayResult(response) {
 // âœ… è™•ç†å®Œå¾Œéš±è— loading æç¤º
  
  document.getElementById("loading").classList.add("hidden");
  //console.log("ğŸŸ¢ displayResult è¢«åŸ·è¡Œï¼");

  const { status, message, action } = response;
  const resultDiv = document.getElementById("result");
  const name = message.split(" ")[0];
  const group = response.displayGroup;
  const now = new Date().toLocaleString();
  //console.log("ğŸŸ¡ å‰ç«¯æ”¶åˆ° action:", action);

  resultDiv.removeAttribute("style");
  resultDiv.innerHTML = "";
  resultDiv.style.padding = "12px";
  resultDiv.style.borderRadius = "8px";
  resultDiv.style.marginTop = "20px";
  resultDiv.style.fontWeight = "bold";
  resultDiv.style.fontSize = "1.3em";
  resultDiv.style.display = "inline-block";

  if (status === "success") {
    if (action === "ç°½åˆ°") {
      resultDiv.style.backgroundColor = "#4CAF50";
      resultDiv.style.color = "white";
      resultDiv.innerHTML = `âœ… <strong>${group}  - ${message}</strong>`;
      // åŠ ä¸Šåˆ—å°è§¸ç™¼
  triggerPrint({ name, group, time: now });
    } else if (action === "ç°½é€€") {
      resultDiv.style.backgroundColor = "#2196F3";
      resultDiv.style.color = "white";
      resultDiv.innerHTML = `ğŸ“¤ <strong>${group}  - ${message}</strong>`;
    } else {
      resultDiv.style.backgroundColor = "#666";
      resultDiv.style.color = "white";
      resultDiv.innerHTML = "âœ… <strong>" + message + "</strong>";
    }
    document.getElementById("groupSelect").value = "";
    handleGroupChange(); // é †ä¾¿éš±è—ç­ç´šæˆ–å…¶ä»–çµ„åˆ¥æ¬„ä½
  } else if (status === "warning") {
    resultDiv.style.backgroundColor = "#fff3cd";
    resultDiv.style.color = "#856404";
    resultDiv.style.border = "1px solid #ffeeba";
    resultDiv.innerHTML = "âš ï¸ " + message;
  } else {
    resultDiv.style.backgroundColor = "#f8d7da";
    resultDiv.style.color = "#721c24";
    resultDiv.style.border = "1px solid #f5c6cb";
    resultDiv.innerHTML = "âŒ " + message;
  }
}


    function showResult(msg, color) {
      const resultDiv = document.getElementById("result");
      resultDiv.style.color = color;
      resultDiv.textContent = msg;
    }

    function initClock() {
      const clock = document.getElementById("clock");
      function update() {
        const now = new Date();
        clock.textContent = now.toLocaleString("zh-TW", {
          hour12: false,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit"
        });
      }
      update();
      setInterval(update, 1000);
    }

  function triggerPrint({ name, group }) {
  const printWindow = window.open('', '_blank', 'width=800,height=600');

  printWindow.document.write(`
    <html>
    <head>
      <style>
        @media print {
          @page {
            size: 70mm 40mm; /* è²¼ç´™å¤§å° */
            margin: 0;
          }
          body {
            margin: 0;
            padding: 0;
          }
        }

        html, body {
          width: 70mm;
          height: 40mm;
          margin: 0;
          padding: 0;
          font-family: "Noto Sans TC", sans-serif;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
          box-sizing: border-box;
        }

        .label {
          width: 100%;
          height: 100%;
          transform: scale(0.98);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          text-align: center;
          box-sizing: border-box;
        }

        .group {
          font-size: 22pt;
          font-weight: bold;
          margin-bottom: 4px;
          white-space: nowrap;
        }

        .name {
          font-size: 26pt;
          font-weight: bold;
          white-space: nowrap;
        }
      </style>
    </head>
    <body onload="window.print(); setTimeout(() => window.close(), 100);">
      <div class="label">
        <div class="group">${group}</div>
        <div class="name">${name}</div>
      </div>
    </body>
    </html>
  `);

  printWindow.document.close();
}
  </script>
</body>
</html>
